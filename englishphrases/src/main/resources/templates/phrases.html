<!DOCTYPE html>
<html>

<head>

    <meta charset="utf-8">
    <title>English phrases</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>

    <link href="css/style.css" rel="stylesheet">
</head>

<body>
<section id="content">

    <br><br>
    <label>Id</label>
    <input data-bind="value: newId" type="text" class='input-field'><br>
    <label>Word</label>
    <input data-bind="value: newWord" type="text" class='input-field'><br>
    <label>Russian</label>
    <input data-bind="value: newRussian" type="text" class='input-field'><br>
    <label>English</label>
    <input data-bind="value: newEnglish" type="text" class='input-field'><br>
    <label>Sound</label>
    <input data-bind="value: newSound" type="text" class='input-field'><br>
    <label>Rule</label>
    <input data-bind="value: newRule" type="text" class='input-field'><br>
    <button data-bind="click: updateRecord">Update record</button>


    <br><br>
    <form data-bind="submit: loadRecordByWord">
        <label>Word</label>
        <input data-bind="value: searchString" type="text">
        <input type="submit" value="Get examples">
    </form>

    <table class="table-sentences">
        <caption>
            <h3>Английские фразы</h3>
        </caption>
        <tr>
            <th>Номер</th>
            <th>Русская версия / Английская версия</th>
            <th>Проигрыватель</th>
        </tr>
        <tbody data-bind="foreach: records">
        <tr>
            <td class="center">
                <input data-bind="event: {change: $parent.showQuestionCheckboxChange}" class="show_question"
                       type="checkbox">
                <span data-bind="text: $data.id"></span></td>
            <td>
                        <span data-bind="attr: {tabindex: ($index() + 100001), data_title: $data.rule}"
                              class='support question_hidden' data-title=''>
                            <em>?</em>
                        </span>
                <span data-bind="text: $data.russian" class="question question_hidden"></span>
                <input data-bind="event: {keyup: $parent.inputFiledKeyUp}, attr: {tabindex: ($index() + 1)}"
                       class='input-field' type="text" placeholder="Введите перевод">
                <span data-bind="text: $data.english" class='tip hide'></span><br>
                <div class='check'></div>
                <button data-bind="click: $parent.editRecord">Edit</button>
            </td>
            <td class="center">
                <a data-bind="event: {click: $parent.musicButtonClick}" class="music-button"><img
                        src="img/player_play.png"></a>
                <audio data-bind="attr: {src: '../words/'+ $data.word + '/' + $data.soundPath}" class="player"
                       type="audio/mpeg"></audio>
                <br><input
                    data-bind="event: {change: $parent.inputRangeInputAndChange, input: $parent.inputRangeInputAndChange}"
                    type="range" step="0.1" min="0.2" max="2" value="1" class="speed"/>
                <br><span class="speed-text">1.0</span>
            </td>
        </tr>
        </tbody>
    </table>
</section>

<script type="text/javascript" src="https://ajax.aspnetcdn.com/ajax/knockout/knockout-3.4.0.js"></script>
<script>
        // The records view model
        function BookmarkViewModel() {
            var self = this;


            self.newId = ko.observable("");
            self.newWord = ko.observable("");
            self.newRussian = ko.observable("");
            self.newEnglish = ko.observable("");
            self.newRule = ko.observable("");
            self.newSound = ko.observable("");

            self.searchString = ko.observable("base");
            self.records = ko.observableArray([]);

            // load records from server: GET on records resource
            self.loadRecordByWord = function () {
                $.ajax("http://localhost:8080/records/" + self.searchString(), {
                    type: "GET",
                    success: function (allData) {
                        var json = ko.toJSON(allData);
                        self.records(JSON.parse(json));
                    }
                });
            };

            self.editRecord = function (record) {
                self.newId(record.id);
                self.newEnglish(record.english);
                self.newRussian(record.russian);
                self.newWord(record.word);
                self.newRule(record.rule);
                self.newSound(record.soundPath);
            }

            self.updateRecord = function () {
                var dataJson = '{"id":' + self.newId() + ',"word":"' + self.newWord() + '","russian":"' + self.newRussian() + '","english":"' + self.newEnglish() + '","soundPath":"' + self.newSound() + '","rule":"' + self.newRule() + '"}';
                console.log(dataJson);
                $.ajax("http://localhost:8080/records/" + self.newId(), {
                    data: dataJson,
                    type: "put",
                    contentType: "application/json",
                    success: function (allData) {
                        self.loadRecordByWord();
                        alert("Record was successful updated");
                    }
                });
            }

            self.inputFiledKeyUp = function (record, event) {
                var $this = $(event.target);

                if ($this.hasClass('invalid')) {
                    $this.removeClass('invalid')
                }

                if ($this.hasClass('correct')) {
                    $this.removeClass('correct')
                }

                if (event.keyCode == 113) {
                    let checkbox = $this.closest('tr')[0].getElementsByClassName('show_question')[0];
                    $(checkbox).trigger('click');
                }

                if (event.keyCode == 13) {
                    var actualVal = "";
                    tipColl = $this.closest('td')[0].getElementsByClassName('tip');
                    for (let i = 0; i < tipColl.length; i++) {
                        actualVal = actualVal + tipColl[i].innerHTML;
                    }
                    actualVal = actualVal.replace(/[\[\]]/g, "");
                    var currentVal = $this.val();
                    var checkDiv = $this.closest('td')[0].getElementsByClassName('check')[0];
                    currentVal = currentVal.replace(/[,:;?.!]/g, "").replace(/[ ]{2,}/g, " ");
                    actualVal = actualVal.replace(/[,:;?.!]/g, "").replace(/[ ]{2,}/g, " ");
                    $this.closest('tr')[0].getElementsByClassName('music-button')[0].click();
                    if (currentVal != actualVal) {
                        $this.addClass('invalid');
                        checkDiv.innerHTML = checkTranslate(actualVal, currentVal);
                    } else {
                        $this.addClass('correct');
                        checkDiv.innerHTML = '';
                    }
                }

                if (event.keyCode == 40) {
                    let currentVal = Number($this.closest('tr')[0].getElementsByClassName('speed')[0].value) - 0.1;
                    $this.closest('tr')[0].getElementsByClassName('speed')[0].value = currentVal;
                    $this.closest('tr')[0].getElementsByClassName('speed')[0].dispatchEvent(new Event("change"));
                }

                if (event.keyCode == 38) {
                    let currentVal = Number($this.closest('tr')[0].getElementsByClassName('speed')[0].value) + 0.1;
                    $this.closest('tr')[0].getElementsByClassName('speed')[0].value = currentVal;
                    $this.closest('tr')[0].getElementsByClassName('speed')[0].dispatchEvent(new Event("change"));
                }
            };

            self.musicButtonClick = function (record, event) {
                var $this = $(event.target);
                audioEl = $this.closest('td')[0].getElementsByTagName('audio')[0];
                audioEl.playbackRate = $this.closest('td')[0].getElementsByClassName('speed')[0].value;
                audioEl.play();
            }

            self.inputRangeInputAndChange = function (record, event) {
                var $this = $(event.target);
                $this.nextAll('.speed-text')[0].innerHTML = parseFloat($this.val()).toFixed(1);
            }

            self.showQuestionCheckboxChange = function (record, event) {
                var $this = $(event.target);
                if ($this.is(":checked")) {
                    $this.closest('tr')[0].getElementsByClassName('question')[0].classList.remove('question_hidden');
                    if ($this.closest('tr')[0].getElementsByClassName('support').length > 0) {
                        $this.closest('tr')[0].getElementsByClassName('support')[0].classList.remove('question_hidden');
                    }
                    return;
                }
                $this.closest('tr')[0].getElementsByClassName('question')[0].classList.add('question_hidden');
                if ($this.closest('tr')[0].getElementsByClassName('support').length > 0) {
                    $this.closest('tr')[0].getElementsByClassName('support')[0].classList.add('question_hidden');
                }
            }
            self.loadRecordByWord();
        }

        ko.options.useOnlyNativeEvents = true;
        ko.applyBindings(new BookmarkViewModel());

    </script>

</body>

<script src="js/check-translate.js"></script>

</html>